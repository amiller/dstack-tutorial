services:
  app:
    build:
      context: .
      dockerfile_inline: |
        FROM node:22-slim
        RUN apt-get update && apt-get install -y openssl
        WORKDIR /app
        RUN npm init -y && npm install @phala/dstack-sdk viem
        COPY index.mjs .
        CMD ["node", "index.mjs"]
    ports:
      - "8443:8443"
    volumes:
      - ${DSTACK_SOCK:-/var/run/dstack.sock}:/var/run/dstack.sock

  ngrok:
    image: ngrok/ngrok:latest
    command: tcp app:8443 --log stdout
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTHTOKEN}
    depends_on:
      - app
