services:
  app:
    build:
      context: .
      dockerfile_inline: |
        FROM node:22-slim
        RUN apt-get update && apt-get install -y openssl && rm -rf /var/lib/apt/lists/*
        WORKDIR /app
        RUN npm init -y && npm install @phala/dstack-sdk express
        RUN cat > app.mjs <<'SCRIPT'
        import { DstackClient } from "@phala/dstack-sdk"
        import express from "express"
        import { createServer } from "https"
        import { execSync } from "child_process"
        import { readFileSync, writeFileSync, existsSync } from "fs"
        import { createHash } from "crypto"

        const client = new DstackClient()
        const app = express()
        app.use(express.text({ type: "*/*" }))
        const DOMAIN = process.env.DOMAIN || "tee-oracle"

        if (!existsSync("/tmp/key.pem")) {
          console.log("Generating keypair and CSR for", DOMAIN)
          execSync("openssl genrsa -out /tmp/key.pem 2048")
          execSync(`openssl req -new -key /tmp/key.pem -out /tmp/csr.pem -subj "/CN=${DOMAIN}"`)
        }

        const csr = readFileSync("/tmp/csr.pem", "utf8")
        const key = readFileSync("/tmp/key.pem")
        let httpsServer = null

        app.get("/", (req, res) => {
          const hasCert = existsSync("/tmp/cert.pem")
          res.json({
            status: hasCert ? "ready" : "waiting_for_cert",
            message: hasCert ? "HTTPS on :443" : "GET /csr, do ACME, POST /cert"
          })
        })

        app.get("/csr", (req, res) => res.type("application/x-pem-file").send(csr))

        app.post("/cert", (req, res) => {
          if (httpsServer) return res.status(400).json({ error: "already running" })
          if (!req.body.includes("BEGIN CERTIFICATE")) return res.status(400).json({ error: "invalid" })
          writeFileSync("/tmp/cert.pem", req.body)
          startHttps()
          res.json({ status: "ok" })
        })

        app.get("/attestation", async (req, res) => {
          const info = await client.getInfo()
          let fp = null
          if (existsSync("/tmp/cert.pem")) {
            const pem = readFileSync("/tmp/cert.pem").toString()
            const der = Buffer.from(pem.replace(/-----(BEGIN|END) CERTIFICATE-----/g, "").replace(/\n/g, ""), "base64")
            fp = createHash("sha256").update(der).digest("hex")
          }
          const quote = await client.getQuote(fp ? Buffer.from(fp, "hex") : Buffer.alloc(64))
          res.json({ appId: info.app_id, certFingerprint: fp, quote: Buffer.from(quote.quote).toString("hex").slice(0, 200) + "..." })
        })

        function startHttps() {
          const cert = readFileSync("/tmp/cert.pem")
          httpsServer = createServer({ cert, key }, (req, res) => {
            res.setHeader("Content-Type", "application/json")
            if (req.url === "/") res.end(JSON.stringify({ status: "ok", tls: true }))
            else { res.statusCode = 404; res.end(JSON.stringify({ error: "not found" })) }
          })
          httpsServer.listen(443, () => console.log("HTTPS on :443"))
        }

        app.listen(8080, () => console.log("Setup on :8080 - GET /csr, POST /cert"))
        SCRIPT
        CMD ["node", "app.mjs"]
    ports:
      - "8080:8080"
      - "443:443"
    environment:
      - DOMAIN=${DOMAIN:-tee-oracle}
    volumes:
      - ${DSTACK_SOCK:-/var/run/dstack.sock}:/var/run/dstack.sock
